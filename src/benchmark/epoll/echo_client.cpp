#include <stdio.h>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <stdlib.h>
#include <unistd.h>
#include <pthread.h>

int N, C;
#define SERVER_PORT 10007
const char *DATA = 
"1111111111111111111111111111111111111111111111111111111111111111111111111111111111111122222222222222222222222222222222222222222222222222222222222222222222222222222222222222233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333344444444444444444444444444444444444444444444444444444444444444444444444444444444444444444455555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555566666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666667777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777788888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999";

void echo()
{
	int sockfd;
	struct sockaddr_in serv_addr;
	int n;
	char buff[1500];

	if((sockfd = socket(AF_INET, SOCK_STREAM, 0)) < 0) {
		printf("Failed creating socket\n");
	}

	bzero((char *) &serv_addr, sizeof (serv_addr));

	serv_addr.sin_family = AF_INET;
	serv_addr.sin_addr.s_addr = inet_addr("127.0.0.1");
	serv_addr.sin_port = htons(SERVER_PORT);

	if (connect(sockfd, (struct sockaddr *) &serv_addr, sizeof (serv_addr)) < 0) {
		printf("Failed to connect to server\n");
		return;
	}

	n = send(sockfd, DATA,strlen(DATA), 0);
	if (n <= 0) {
		close(sockfd);
		return;
	}

	n = recv(sockfd, buff, 1500, 0);
	close(sockfd);

	return;
}

void* handler(void *arg)
{
	int i;
	for (i=0; i<C; i++) {
		echo();
	}
	return NULL;
}

int main(int argc, char **argv) 
{
	N = atoi(argv[1]);
	C = atoi(argv[2]);
	int i;
	pthread_t tid[N];


	for (i=0; i<N; i++) {
		pthread_create(&tid[i], NULL, handler, NULL);
	}

	for (i=0; i<N; i++) {
		pthread_join(tid[i], NULL);
	}
	return 0;
}
